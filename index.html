<!doctype html>

<canvas id="canvas1" style="position: relative"></canvas>
<canvas id="canvas2"></canvas>

<script src="bower_components/requirejs/require.js"></script>
<script>
  
  requirejs.config({
    packages: [
      { name: 'when', location: '/bower_components/when', main: 'when' }
    ]
  });
  
  require(['getRadar', 'createImages', 'when', 'rainRadius'], function(getRadar, createImages, when, rainRadius){
        
    getRadar().then(function(data){
      data.radar.sort(function(a, b){
        return a.date < b.date ? -1 : a.date > b.date ? 1 : 0;
      });
      return data.radar;
    }).then(function(available){
      return when.all(available.map(createImages));
    }).then(function(images){
      return images.map(function(image){
        image.rain = rainRadius(image.image, image.image.width>>1, image.image.height>>1);
        return image;
      })
    }).then(function(images){
      
      var c1 = document.querySelector('#canvas1');
      c1.width = images[0].image.width;
      c1.height = images[0].image.height;
      var ctx1 = c1.getContext('2d');
      var c2 = document.querySelector('#canvas2');
      c2.width = images[0].image.width;
      c2.height = images[0].image.height;
      var ctx2 = c2.getContext('2d');
      
      c1.addEventListener('click', function(event){
        images.forEach(function(image){
          image.rain = rainRadius(image.image, event.x, event.y);
        })
      });
      
      var index = 0;
      var delay = 3;
      function showImage(){
        ctx1.drawImage(images[index>>delay].image, 0, 0);
        ctx2.putImageData(images[index>>delay].rain, 0, 0);
        index = (index + 1) % (images.length<<delay);
        
        window.requestAnimationFrame(showImage);
      }
      
      window.requestAnimationFrame(showImage);
      
    }).catch(function(err){
      console.error(err);
    });
    
  });
  
  /*
  
  i=0
  r=1
  X
  
  i=1
  r=3
  s=x-1 => x
  +-+
  | |
  +-+
  
  i=2
  r=5
  s=x-2 => x+1
  +---+
  |   |
  |   |
  |   |
  +---+
  
  
  
  */
  define('rainRadius', ['imageData', 'loop', 'rgb2hsv'], function(getImageData, loop, rgb2hsv){
    return function(image, _x, _y){
      var imageData = getImageData(image);
      
      var rain = [];
      var radius = Math.max(_x, _y, imageData.width - _x, imageData.height - _y);
      
      loop(radius, function(x, y){
        if(_x + x < 0
           || _x + x > imageData.width
           || _y + y < 0
           || _y + y > imageData.height){
          return
        }
        var r = Math.sqrt(x*x + y*y);
        var index = ((_y+y)*image.width + (_x+x))*4;
        var color = rgb2hsv(imageData.data[index], imageData.data[index+1], imageData.data[index+2]);
        
        //console.log(_x + x, _y + y, index, imageData.data[index], imageData.data[index+1], imageData.data[index+2]);
        if(color.h < 100 && color.v > 70){
          imageData.data[index+0] = 0xff;
          imageData.data[index+1] = Math.floor(r/radius*255);
          imageData.data[index+2] = 0x00;
          //rain.push({color:color, radius: r});
        }else{
          //console.log(_x+x, _y+y, r, false);
          imageData.data[index+0] = 0x00;
          imageData.data[index+1] = 0x00;
          imageData.data[index+2] = 0x00;
        }
      });
      
      //rain.sort(function(a, b){
      //  return a.radius - b.radius;
      //});
      //return rain[0];
      return imageData;
    };
  });
  
  define('loop', [], function(){
    return function(radius, func){
      for(var r=1; r<radius; r++){
        for(var y=-r; y<r; y++){
          var x = r;
          func(x, y);
        }
        for(var x=r; x>-r; x--){
          var y = r;
          func(x, y);
        }
        for(var y=r; y>-r; y--){
          var x = - r;
          func(x, y);
        }
        for(var x=-r; x<r; x++){
          var y = - r;
          func(x, y);
        }
      }
    };
  });
  
  define('getRadar', ['promise', 'ajax'], function(promise, ajax){
    
    return ajax.bind(null, "/available");
    
  });
  
  define('createImages', ['promise'], function(promise){
    return promise(function(entry, resolve, reject){
      var obj = {
        date: Date.parse(entry.date),
        url: entry.url,
        image: new Image()
      };
      obj.image.src = '/image/' + entry.url.substr(entry.url.indexOf('?'));
      obj.image.onload = function(){
        resolve(obj);
      };
      obj.image.onerror = reject;
    });
  });
  
  
  define('ajax', ['promise'], function(promise){
    
  
    return promise(function(url, resolve, reject){
      console.log("ajax", url);
      var xhr = new XMLHttpRequest();
      
      xhr.onload = function(){
        console.log(xhr.responseText);
        resolve(JSON.parse(xhr.responseText));
      };
      
      xhr.onerror = function(){
        console.log("error", xhr.statusText);
      };
      
      
      xhr.onreadystatechange = function(){
        console.log("readystate", xhr.readyState, xhr.status);
      };
      
      
      xhr.open("get", url, true);
      xhr.send();
    });

    
  });
  
  define('rgb2hsv', [], function(){
    return function rgb2hsv () {
      var rr, gg, bb,
          r = arguments[0] / 255,
          g = arguments[1] / 255,
          b = arguments[2] / 255,
          h, s,
          v = Math.max(r, g, b),
          diff = v - Math.min(r, g, b),
          diffc = function(c){
              return (v - c) / 6 / diff + 1 / 2;
          };

      if (diff == 0) {
          h = s = 0;
      } else {
          s = diff / v;
          rr = diffc(r);
          gg = diffc(g);
          bb = diffc(b);

          if (r === v) {
              h = bb - gg;
          }else if (g === v) {
              h = (1 / 3) + rr - bb;
          }else if (b === v) {
              h = (2 / 3) + gg - rr;
          }
          if (h < 0) {
              h += 1;
          }else if (h > 1) {
              h -= 1;
          }
      }
      return {
          h: Math.round(h * 360),
          s: Math.round(s * 100),
          v: Math.round(v * 100)
      };
    }
  });
  
  define('promise', ['when'], function(when){
    
    return function(promise){
      return function(data){
        if(arguments.length == 0){
          return when.promise(promise);
        }else{
          return when.promise(promise.bind(null, data));
        }
      };
    };
    
  });

  
  define('imageData', [], function(){
    return function(image){
      var c = document.createElement('canvas');
      var ctx = c.getContext('2d');
      c.width = image.width;
      c.height = image.height;
      ctx.drawImage(image, 0, 0);
      return ctx.getImageData(0, 0, c.width, c.height);
    }
  });



</script>