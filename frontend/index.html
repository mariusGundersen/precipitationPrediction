<!doctype html>

<style>
*{
  margin: 0;
}
</style>

<canvas id="canvas1" style="position: relative"></canvas>
<canvas id="canvas2"></canvas>

<script src="bower_components/requirejs/require.js"></script>
<script>
  
  requirejs.config({
    baseUrl:'/js',
    packages: [
      { name: 'when', location: '/bower_components/when', main: 'when' }
    ]
  });
  
  require(['getRadar', 'createImages', 'when', 'imageData', 'findRain', 'linearBestFit'], function(getRadar, createImages, when, imageData, findRain, linearBestFit){
        
    getRadar().then(function(data){
      return data.radar.sort(function(a, b){
        return a.date < b.date ? -1 : a.date > b.date ? 1 : 0;
      });
    }).then(function(available){
      return when.all(available.map(function(entry){
        return createImages(entry)
        .then(function(image){
          image.imageData = imageData(image.image);
          return findRain(image.url, image.imageData, image.imageData.width/2, image.imageData.height/2)
          .then(function(data){
            image.rain = data;
            return image;
          })
        });
      }));
    }).then(function(images){
            
      var c1 = document.querySelector('#canvas1');
      c1.width = images[0].image.width;
      c1.height = images[0].image.height;
      var ctx1 = c1.getContext('2d');
      var c2 = document.querySelector('#canvas2');
      c2.width = images[0].image.width;
      c2.height = images[0].image.height;
      var ctx2 = c2.getContext('2d');
      
      
      var drag = {};
      
      c1.addEventListener('mousedown', function(event){
        console.log(event.pageX, event.pageY);
        drag.dragging = true;
        drag.startX = event.pageX;
        drag.startY = event.pageY;
        /*images.forEach(function(image){
            return findRain(image.url, image.imageData, event.pageX, event.pageY)
          .then(function(data){
            image.rain = data;
            return image;
          });
        })*/
      });
      
      c1.addEventListener('mousemove', function(event){
        if(drag.dragging){
          var deltaX = event.pageX - drag.startX;
          var deltaY = event.pageY - drag.startY;
          var dist = Math.sqrt(deltaX*deltaX + deltaY*deltaY);
          drag.dirX = deltaX/dist;
          drag.dirY = deltaY/dist;        
        }
      });
      
      c1.addEventListener('mouseup', function(event){
        if(drag.dragging){
          drag.dragging = false;
          var start = images[0].date.valueOf();
          var dirX = drag.dirX;
          var dirY = drag.dirY;
          var points = images.map(function(image){
            return sweep(dirX, dirY, 15).map(function(dir){
              return {x: image.date - start, y: nearestRain(image.rain, dir.dirX, dir.dirY, drag.startX, drag.startY)};
            });
          }).reduce(function(a, b){
            return a.concat(b);
          }, []);
          console.log(points.map(function(point){return point.x+", "+point.y;}));
          var bestFit = linearBestFit(points);
          console.log(bestFit);
          console.log(new Date(bestFit.b + start));
        }        
      });
      
      var index = 0;
      var delay = 3;
      function showImage(){
        ctx1.drawImage(images[index>>delay].image, 0, 0);
        ctx2.putImageData(images[index>>delay].rain, 0, 0);
        index = (index + 1) % (images.length<<delay);
        
        if(drag.dragging){
          ctx2.beginPath();
          ctx2.strokeStyle = "white";
          ctx2.moveTo(drag.startX, drag.startY);
          ctx2.lineTo(drag.startX + drag.dirX*100, drag.startY + drag.dirY*100);
          ctx2.stroke();
        }
        
        
        window.requestAnimationFrame(showImage);
      }
      
      window.requestAnimationFrame(showImage);
      
    }).catch(function(err){
      console.error(err.message, err.stack);
    });
    
  });
  
  function nearestRain(rain, dirX, dirY, startX, startY){
    for(var i=0; i<200; i++){
      var x = Math.round(startX + dirX*i);
      var y = Math.round(startY + dirY*i);

      var isRain = rain.data[(y*rain.width + x)*4];
      rain.data[(y*rain.width + x)*4 + 2] = 0xff;
      if(isRain){
        return i;
      }
    }
    return 200;
  }
  
  function sweep(dirX, dirY, degrees){
    var angles = [];
    var resolution = 10
    
    var radians = degrees*Math.PI/180;
    
    for(var i=-resolution; i<resolution; i++){
      var a = Math.atan2(dirY, dirX) + radians/resolution*i;
      angles.push({
        dirX: Math.cos(a),
        dirY: Math.sin(a)
      });
    }
    
    return angles;
  }
  
  
  define('getRadar', ['promise', 'ajax'], function(promise, ajax){
    
    return ajax.bind(null, "/available");
    
  });
  
  define('createImages', ['promise'], function(promise){
    return promise(function(entry, resolve, reject){
      var obj = {
        date: Date.parse(entry.date),
        url: entry.url,
        image: new Image()
      };
      obj.image.src = '/image/' + entry.url.substr(entry.url.indexOf('?'));
      obj.image.onload = function(){
        resolve(obj);
      };
      obj.image.onerror = reject;
    });
  });
  
  
  
  
  
  define('findRain', ['when'], function(when){
    
    var worker = new Worker('/js/worker.js');
    
    worker.onmessage = function(event){
      console.log(event.data.id, event.data.imageData.data[0]);
      images[event.data.id].resolve(event.data.imageData);
    };
    
    var images = Object.create(null);
    
    return function(id, imageData, x, y){
      console.log(id, x, y);
      var data = (imageData.data);
      
      worker.postMessage({
        id: id,
        imageData: imageData,
        x: x,
        y: y
      });
            
      images[id] = when.defer();
      
      return images[id].promise;      
    };
    
  });
  



</script>